How to Load Data
================

There are a few files that need to exist for Pheweb to work.
We provide a "pipeline" that can generate those required files from the output of EPACTS with PheWAS codes that are aggregated from ICD-9 codes.
If your data does not fit our assumptions, you might want to jump into the pipeline a little later.
The pipeline is described here in a way similar to a Makefile.
The scripts are in the directory `data/`, and the data is in the directory `$data_dir` which is defined in `config.config`.

If your phenotypes are not PheWAS codes aggregated from ICD-9 codes, some changes to this project will be needed.


Pheweb:
- requires `matrix.tsv.gz` and `matrix.tsv.gz.tbi`
- requires `phenos.json`
- requires `$data_dir/manhattan/<pheno_code>.json`
- requires `$data_dir/qq/<pheno_code>.json`
- requires a python2.7 virtualenv with the packages in `requirements.txt` so that `$virtualenv_dir/bin/activate` (defined in `config.config`) will work.

`matrix.tsv.gz` and `matrix.tsv.gz.tbi`:
- requires `matrix.tsv`
- generated by `4_2_bgzip.sh`

`matrix.tsv`:
- requires `$data_dir/augmented_pheno/<pheno_code>`
- generated by `4_1_make_matrix.sh` which uses `matrixify.cpp`
- format:
    - tab-delimited
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet
        - `rsids`: like `rs865924913` or `rs74918077,rs3131966`
        - `nearest_genes`: like `AL669831.1` or `SAMD11,AL645608.1`
        - `maf`: like `0.366233` or `1.23e-4`
        - `pval-<pheno_code>`: like `0.366233` or `1.23e-4`.  There must be one column like this for each phenotype.

`$data_dir/augmented_pheno/<pheno_code>`:
- requires EPACTS input files
- requires `$data_dir/phenos.csv`
- requires `$data_dir/sites/sites.tsv`
- generated by `3_1_standardize_each_pheno.py`
- format:
    - tab-delimited
    - Each of these files should have the exact same first four columns
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet
        - `rsids`: like `rs865924913` or `rs74918077,rs3131966`
        - `nearest_genes`: like `AL669831.1` or `SAMD11,AL645608.1`
        - `maf`: like `0.366233` or `1.23e-4`
        - `pval`: like `0.366233` or `1.23e-4`.

EPACTS input files:
- format:
    - tab-delimited
    - Each of these files should have the exact same first four columns
    - columns must include:
        - `#CHROM`: numeric, 1-22
        - `BEGIN`: position
        - `MARKER_ID`: in the format `{numeric_chromosome}:{position}_{reference}/{alternate}_{numeric_chromosome}:{position}`.  Reference and alternate must be one base each.
        - `MAF`: like `0.366233` or `1.23e-4`
        - `PVALUE`: like `0.366233` or `1.23e-4`.

`$data_dir/sites/sites.tsv`:
- requires `$data_dir/sites/cpra.tsv`
- generated by `1_2_download_rsids.sh && 1_3_download_genes.sh && 1_4_make_cpra_rsids.py && 1_5_make_cpra_rsids_genes.sh && 1_6_make_sites_lexicographic.py && 1_7_make_sites.sh`
- format:
    - tab-delimited
    - each of these chr-pos-ref-alt should be in every input file
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet
        - `rsids`: like `rs865924913` or `rs74918077,rs3131966`
        - `nearest_genes`: like `AL669831.1` or `SAMD11,AL645608.1`

`$data_dir/sites/cpra.tsv`:
- requires EPACTS input files
- requires `$data_dir/phenos.csv`
- uses `minimum_maf` from `config.config`
- generated by `0_1_get_cpras_from_each_input_file.py && 0_2_get_cpras_to_show.py`
- format:
    - tab-delimited
    - each of these chr-pos-ref-alt should be in every input file
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet

`phenos.json`:
- requires `$data_dir/phenos.csv`
- requires EPACTS input files with columns `NS.CTRL` (number of controls) and `NS.CASE` (number of cases).
    - The number of cases and controls must be constant within a phenotype.  The presence of those numbers on every line is just redundant.
- uses `data/PheWAS_code_translation_v1_2.txt`, which is already in this repository.
- uses `minimum_num_cases` from `config.config`.
- generated by `2_make_phenos_json.py`, assuming that you are using PheWAS codes based on ICD-9 codes.

`$data_dir/phenos.csv`:
- uses `source_filenames_pattern` (a shell glob) from `config.config`
- uses `source_filenames_pheno_code_extracting_regex` (a regex) from `config.config`
- generated by `0_0_make_phenos_csv.py`
