How to Load Data
================

There are a few files that need to exist for Pheweb to work.

We provide a "pipeline" that can generate those required files from the output of EPACTS (one-phenotype-at-a-time) with PheWAS codes that are aggregated from ICD-9 codes.
If your data does not fit our assumptions, you might want to jump into the pipeline a little later.

Example modifications:
- If you aren't using Vanderbilt-style ICD9-based PheWAS codes and categories, you'll need to follow the alternate instructions listed under `data/phenos.json` and `$data_dir/phenos.csv`.
- If you aren't using EPACTS-format input files, you'll need to make an alternative to `data/input_file_parsers/epacts.py` and change `source_file_parser` in `config.config`.

The pipeline is described here in a way similar to a Makefile.

The scripts are in the directory `data/`, and the data is in the directory `$data_dir` which is defined in `config.config`.


**Pheweb:**
- rquires `config.config` in the root of the repository (where one currently is).
- requires `data/phenos.json`
- requires `matrix.tsv.gz` and `matrix.tsv.gz.tbi`
- requires `$data_dir/manhattan/<pheno_code>.json`
- requires `$data_dir/qq/<pheno_code>.json`
- requires `$data_dir/sites/rsid_to_cpra_trie.marisa` and `$data_dir/sites/cpra_to_rsids_trie.marisa`

**`config.config`:**
- `virtualenv_dir`: a python2.7 virtualenv with the packages in `requirements.txt` so that `$virtualenv_dir/bin/activate` (defined in `config.config`) will work.
    - Run:

    ```
    virtualenv --python=python2.7 /some/path/venv
    /some/path/venv/bin/activate
    pip install -r requirement.txt # the `requirements.txt` in this repository.
    ```

    - Then set `virtualenv_dir="/some/path/venv"`.
- `data_dir`: some directory where you can afford to store twice as much data as the size of your input files.
    - If you don't have write access to `$data_dir`, you'll need to prefix most commands with `sudo `.
- `source_filenames_pattern`: see information for `$data_dir/phenos.csv` below.
- `source_filenames_pheno_code_extracting_regex`: see information for `$data_dir/phenos.csv` below.
- `source_file_parser`: should correspond to a python file `data/input_file_parsers/<source_file_parser>.py`.
- `minimum_maf`: see information for `$data_dir/sites/cpra.tsv` below.
- `minimum_num_cases`: see information for `$data_dir/sites/cpra.tsv` below.
- `bedtools_path`: directory that contains a `bedtools` executable, for `data/1_3_download_genes.sh` and `data/1_5_make_cpra_rsids_genes.sh`.
- `use_vanderbilt_phewas_icd9s_and_categories`: see information for `data/phenos.json` below.

**`data/phenos.json`:**
- requires `$data_dir/phenos.csv`
- requires EPACTS input files with columns `NS.CTRL` (number of controls) and `NS.CASE` (number of cases).
    - The number of cases and controls must be constant within a phenotype.  The presence of those numbers on every line is just redundant.
- uses `minimum_num_cases` from `config.config`.
- uses `use_vanderbilt_phewas_icd9s_and_categories` from `config.config`.
    - If `True`, `2_make_phenos_json.py` will use `data/PheWAS_code_translation_v1_2.txt` (which is already in this repository) to get the category and ICD-9 codes for each phenotype.
    - If `False`, `2_make_phenos_json.py` will expect a column named `category_string` in `$data_dir/phenos.csv`.
- generated by `2_make_phenos_json.py`.
- lives in the repository, for version control.
- format (example [here](https://raw.githubusercontent.com/statgen/pheweb/master/data/phenos.json)):

    ```
    {
        "<pheno_code>": { # <pheno_code> must uniquely identify this phenotype and be URL-safe.
            "category_string": "<category_string>", # <category_string> can be any string.  Multiple phenotypes may share a <category_string> to show them together on the PheWAS plot.
            "num_cases": <number_of_cases_for_this_phenotype>,
            "num_controls": <number_of_controls_for_this_phenotype>,
            "phewas_string": "<pheno_string>" # <pheno_string> will be the header on the page.
            # Optionally, may also include the key "icd9s".  See the example file for the format.
        }, ...
    }
    ```

**`$data_dir/phenos.csv`:**
- uses `source_filenames_pattern` (a shell glob) from `config.config`
- uses `source_filenames_pheno_code_extracting_regex` (a regex) from `config.config`
- generated by `0_0_make_phenos_csv.py`
- format:
    - comma-delimited
    - columns:
        - `pheno_code`: the short string that will identify this phenotype. Must be URL-safe.
        - `src_filename`: the path to the input file with data for this phenotype.
        - `category_string`: must be added manually if `use_vanderbilt_phewas_icd9s_and_categories` (in `config.config`) is False.

**`matrix.tsv.gz` and `matrix.tsv.gz.tbi`:**
- requires `matrix.tsv`
- generated by `4_2_bgzip.sh`

**`matrix.tsv`:**
- requires `$data_dir/augmented_pheno/<pheno_code>`
- generated by `4_1_make_matrix.sh` which uses `matrixify.cpp`
- format:
    - tab-delimited
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet
        - `rsids`: like `rs865924913` or `rs74918077,rs3131966`
        - `nearest_genes`: like `AL669831.1` or `SAMD11,AL645608.1`
        - `maf`: like `0.366233` or `1.23e-4`
        - `pval-<pheno_code>`: like `0.366233` or `1.23e-4`.  There must be one column like this for each phenotype.

**`$data_dir/augmented_pheno/<pheno_code>`:**
- requires EPACTS input files
- requires `$data_dir/phenos.csv`
- requires `$data_dir/sites/sites.tsv`
- generated by `3_1_standardize_each_pheno.py`
- format:
    - tab-delimited
    - Each of these files should have the exact same first four columns
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet
        - `rsids`: like `rs865924913` or `rs74918077,rs3131966`
        - `nearest_genes`: like `AL669831.1` or `SAMD11,AL645608.1`
        - `maf`: like `0.366233` or `1.23e-4`
        - `pval`: like `0.366233` or `1.23e-4`.

**EPACTS input files:**
- format:
    - one phenotype per file
    - must be listed in `$data_dir/phenos.csv`
    - tab-delimited
    - Each of these files should have the exact same first four columns
    - columns must include:
        - `#CHROM`: numeric, 1-22
        - `BEGIN`: position
        - `MARKER_ID`: in the format `{numeric_chromosome}:{position}_{reference}/{alternate}_{numeric_chromosome}:{position}`.  Reference and alternate must be one base each.
        - `MAF`: like `0.366233` or `1.23e-4`
        - `PVALUE`: like `0.366233` or `1.23e-4`.

**`$data_dir/sites/sites.tsv`:**
- requires `$data_dir/sites/cpra.tsv`
- generated by `1_2_download_rsids.sh && 1_3_download_genes.sh && 1_4_make_cpra_rsids.py && 1_5_make_cpra_rsids_genes.sh && 1_6_make_sites_lexicographic.py && 1_7_make_sites.sh`
- format:
    - tab-delimited
    - each of these chr-pos-ref-alt should be in every input file
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet
        - `rsids`: like `rs865924913` or `rs74918077,rs3131966`
        - `nearest_genes`: like `AL669831.1` or `SAMD11,AL645608.1`

**`$data_dir/sites/cpra.tsv`:**
- requires EPACTS input files
- requires `$data_dir/phenos.csv`
- uses `minimum_maf` from `config.config`
- generated by `0_1_get_cpras_from_each_input_file.py && 0_2_get_cpras_to_show.py`
- format:
    - tab-delimited
    - each of these chr-pos-ref-alt should be in every input file
    - columns:
        - `chr`: numeric, 1-22
        - `pos`
        - `ref`: one base - no indels yet
        - `alt`: one base - no indels yet

**`$data_dir/manhattan/<pheno_code>.json`:**
- requires `$data_dir/augmented_pheno/<pheno_code>`
- generated by `3_2_make_manhattan_for_each_pheno.py`

**`$data_dir/qq/<pheno_code>.json`**
- requires `$data_dir/augmented_pheno/<pheno_code>`
- generated by `3_3_make_QQ_for_each_pheno.py`

**`$data_dir/sites/rsid_to_cpra_trie.marisa` and `$data_dir/sites/cpra_to_rsids_trie.marisa`:**
- requires `$data_dir/sites/sites.tsv`
- generated by `1_8_make_tries.py`
